'use client';

import { useEffect, useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { DashboardLayout } from '@/components/dashboard-layout';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { ArrowLeft, Plus, Download, Trash2, CreditCard as Edit2, Link2, RefreshCw } from 'lucide-react';
import { supabase } from '@/lib/supabase';
import { useHousehold } from '@/lib/household-context';
import { useToast } from '@/hooks/use-toast';
import { format, parseISO } from 'date-fns';

interface Account {
  id: string;
  name: string;
  type: string;
  institution: string | null;
  account_number_last4: string | null;
  balance: number;
  color: string;
  plaid_item_id?: string;
}

interface Transaction {
  id: string;
  date: string;
  description: string;
  amount: number;
  category: string | null;
  notes: string | null;
  is_pending: boolean;
  plaid_transaction_id: string | null;
  debt_id: string | null;
  created_at: string;
}

interface TransactionCategory {
  id: string;
  name: string;
  type: string;
  icon: string | null;
  color: string;
  is_default: boolean;
}

interface Debt {
  id: string;
  name: string;
  current_balance: number;
  interest_rate: number;
}

export default function AccountDetailPage() {
  const params = useParams();
  const router = useRouter();
  const { toast } = useToast();
  const { currentHousehold } = useHousehold();
  const [account, setAccount] = useState<Account | null>(null);
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [categories, setCategories] = useState<TransactionCategory[]>([]);
  const [debts, setDebts] = useState<Debt[]>([]);
  const [loading, setLoading] = useState(true);
  const [addDialogOpen, setAddDialogOpen] = useState(false);
  const [editingTransaction, setEditingTransaction] = useState<Transaction | null>(null);
  const [showAddCategory, setShowAddCategory] = useState(false);
  const [newCategoryName, setNewCategoryName] = useState('');
  const [newCategoryType, setNewCategoryType] = useState<'income' | 'expense' | 'transfer'>('expense');
  const [newCategoryIcon, setNewCategoryIcon] = useState('');
  const [newCategoryColor, setNewCategoryColor] = useState('#64748b');
  const [transactionForm, setTransactionForm] = useState({
    date: format(new Date(), 'yyyy-MM-dd'),
    description: '',
    amount: '',
    category: '',
    notes: '',
    is_pending: false,
    debt_id: '',
  });

  const accountId = params.id as string;
  const isPlaidAccount = account?.plaid_item_id != null;

  useEffect(() => {
    if (currentHousehold && accountId) {
      loadAccountData();
      loadCategories();
      loadDebts();
    }
  }, [currentHousehold, accountId]);

  const loadDebts = async () => {
    if (!currentHousehold) return;

    try {
      const { data, error } = await supabase
        .from('debts')
        .select('id, name, current_balance, interest_rate')
        .eq('household_id', currentHousehold.id)
        .order('name');

      if (error) throw error;
      setDebts(data || []);
    } catch (error: any) {
      console.error('Error loading debts:', error);
    }
  };

  const loadCategories = async () => {
    if (!currentHousehold) return;

    try {
      const { data, error } = await supabase
        .from('transaction_categories')
        .select('*')
        .eq('household_id', currentHousehold.id)
        .order('name');

      if (error) throw error;
      setCategories(data || []);
    } catch (error: any) {
      console.error('Error loading categories:', error);
    }
  };

  const handleAddCategory = async () => {
    if (!currentHousehold || !newCategoryName.trim()) return;

    try {
      const { error } = await supabase
        .from('transaction_categories')
        .insert({
          household_id: currentHousehold.id,
          name: newCategoryName.trim(),
          type: newCategoryType,
          icon: newCategoryIcon || null,
          color: newCategoryColor,
          is_default: false,
        });

      if (error) throw error;

      toast({
        title: 'Success',
        description: 'Category added successfully',
      });

      setNewCategoryName('');
      setNewCategoryIcon('');
      setNewCategoryColor('#64748b');
      setShowAddCategory(false);
      await loadCategories();
    } catch (error: any) {
      toast({
        title: 'Error',
        description: error.message || 'Failed to add category',
        variant: 'destructive',
      });
    }
  };

  const loadAccountData = async () => {
    if (!currentHousehold || !accountId) return;

    setLoading(true);
    try {
      // Try to load from manual accounts first
      let { data: accountData, error: accountError } = await supabase
        .from('accounts')
        .select('*')
        .eq('id', accountId)
        .eq('household_id', currentHousehold.id)
        .single();

      // If not found in manual accounts, try plaid_accounts
      if (accountError && accountError.code === 'PGRST116') {
        const { data: plaidData, error: plaidError } = await supabase
          .from('plaid_accounts')
          .select('*')
          .eq('id', accountId)
          .eq('household_id', currentHousehold.id)
          .single();

        if (plaidError) throw plaidError;
        accountData = plaidData;
      } else if (accountError) {
        throw accountError;
      }

      setAccount(accountData);

      // Load transactions
      const { data: transactionsData, error: transactionsError } = await supabase
        .from('transactions')
        .select('*')
        .eq('account_id', accountId)
        .order('date', { ascending: false })
        .order('created_at', { ascending: false });

      if (transactionsError) throw transactionsError;

      setTransactions(transactionsData || []);
    } catch (error: any) {
      console.error('Error loading account data:', error);
      toast({
        title: 'Error',
        description: error.message || 'Failed to load account',
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };

  const handleAddTransaction = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!currentHousehold || !accountId) return;

    setLoading(true);
    try {
      const amount = parseFloat(transactionForm.amount);

      const { error } = await supabase
        .from('transactions')
        .insert({
          account_id: accountId,
          household_id: currentHousehold.id,
          date: transactionForm.date,
          description: transactionForm.description,
          amount: amount,
          category: transactionForm.category || null,
          notes: transactionForm.notes || null,
          is_pending: transactionForm.is_pending,
          debt_id: transactionForm.debt_id || null,
        });

      if (error) throw error;

      // Update account balance
      const newBalance = (account?.balance || 0) + amount;
      const table = isPlaidAccount ? 'plaid_accounts' : 'accounts';
      await supabase
        .from(table)
        .update({ balance: newBalance })
        .eq('id', accountId);

      toast({
        title: 'Success',
        description: 'Transaction added successfully',
      });

      setTransactionForm({
        date: format(new Date(), 'yyyy-MM-dd'),
        description: '',
        amount: '',
        category: '',
        notes: '',
        is_pending: false,
        debt_id: '',
      });
      setAddDialogOpen(false);
      await loadAccountData();
    } catch (error: any) {
      toast({
        title: 'Error',
        description: error.message || 'Failed to add transaction',
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };

  const handleEditTransaction = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!editingTransaction || !currentHousehold || !accountId) return;

    setLoading(true);
    try {
      const amount = parseFloat(transactionForm.amount);
      const amountDifference = amount - editingTransaction.amount;

      const { error } = await supabase
        .from('transactions')
        .update({
          date: transactionForm.date,
          description: transactionForm.description,
          amount: amount,
          category: transactionForm.category || null,
          notes: transactionForm.notes || null,
          is_pending: transactionForm.is_pending,
          debt_id: transactionForm.debt_id || null,
        })
        .eq('id', editingTransaction.id);

      if (error) throw error;

      // Update account balance
      const newBalance = (account?.balance || 0) + amountDifference;
      const table = isPlaidAccount ? 'plaid_accounts' : 'accounts';
      await supabase
        .from(table)
        .update({ balance: newBalance })
        .eq('id', accountId);

      toast({
        title: 'Success',
        description: 'Transaction updated successfully',
      });

      setEditingTransaction(null);
      setTransactionForm({
        date: format(new Date(), 'yyyy-MM-dd'),
        description: '',
        amount: '',
        category: '',
        notes: '',
        is_pending: false,
        debt_id: '',
      });
      await loadAccountData();
    } catch (error: any) {
      toast({
        title: 'Error',
        description: error.message || 'Failed to update transaction',
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteTransaction = async (transaction: Transaction) => {
    if (!confirm('Delete this transaction? This action cannot be undone.')) return;

    setLoading(true);
    try {
      const { error } = await supabase
        .from('transactions')
        .delete()
        .eq('id', transaction.id);

      if (error) throw error;

      // Update account balance
      const newBalance = (account?.balance || 0) - transaction.amount;
      const table = isPlaidAccount ? 'plaid_accounts' : 'accounts';
      await supabase
        .from(table)
        .update({ balance: newBalance })
        .eq('id', accountId);

      toast({
        title: 'Success',
        description: 'Transaction deleted successfully',
      });

      await loadAccountData();
    } catch (error: any) {
      toast({
        title: 'Error',
        description: error.message || 'Failed to delete transaction',
        variant: 'destructive',
      });
    } finally {
      setLoading(false);
    }
  };

  const openEditDialog = (transaction: Transaction) => {
    setEditingTransaction(transaction);
    setTransactionForm({
      date: transaction.date,
      description: transaction.description,
      amount: transaction.amount.toString(),
      category: transaction.category || '',
      notes: transaction.notes || '',
      is_pending: transaction.is_pending,
      debt_id: transaction.debt_id || '',
    });
  };

  const handleSyncPlaid = async () => {
    toast({
      title: 'Coming Soon',
      description: 'Plaid transaction sync will be implemented next.',
    });
  };

  if (loading && !account) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <p className="text-muted-foreground">Loading account...</p>
        </div>
      </DashboardLayout>
    );
  }

  if (!account) {
    return (
      <DashboardLayout>
        <div className="flex items-center justify-center h-96">
          <div className="text-center">
            <p className="text-muted-foreground mb-4">Account not found</p>
            <Button onClick={() => router.push('/dashboard/accounts')}>
              <ArrowLeft className="h-4 w-4 mr-2" />
              Back to Accounts
            </Button>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  const runningBalance = [...transactions].reverse().reduce((acc, transaction, index) => {
    const balance = index === 0 ? (account.balance - transactions.reduce((sum, t) => sum + t.amount, 0) + transaction.amount) : acc[index - 1].balance + transaction.amount;
    acc.push({ ...transaction, balance });
    return acc;
  }, [] as any[]).reverse();

  return (
    <DashboardLayout>
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Button variant="ghost" size="sm" onClick={() => router.push('/dashboard/accounts')}>
              <ArrowLeft className="h-4 w-4" />
            </Button>
            <div>
              <div className="flex items-center gap-2">
                <h1 className="text-3xl font-bold text-primary">{account.name}</h1>
                {isPlaidAccount && (
                  <Badge variant="secondary">
                    <Link2 className="h-3 w-3 mr-1" />
                    Linked
                  </Badge>
                )}
              </div>
              <p className="text-muted-foreground">
                {account.institution && <span>{account.institution} • </span>}
                <span className="capitalize">{account.type}</span>
                {account.account_number_last4 && <span> • ••••{account.account_number_last4}</span>}
              </p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            {isPlaidAccount ? (
              <Button onClick={handleSyncPlaid}>
                <RefreshCw className="h-4 w-4 mr-2" />
                Sync Transactions
              </Button>
            ) : (
              <Dialog open={addDialogOpen} onOpenChange={setAddDialogOpen}>
                <DialogTrigger asChild>
                  <Button>
                    <Plus className="h-4 w-4 mr-2" />
                    Add Transaction
                  </Button>
                </DialogTrigger>
                <DialogContent>
                  <DialogHeader>
                    <DialogTitle>Add Transaction</DialogTitle>
                    <DialogDescription>
                      Record a new transaction for this account
                    </DialogDescription>
                  </DialogHeader>
                  <form onSubmit={handleAddTransaction}>
                    <div className="space-y-4">
                      <div>
                        <Label htmlFor="date">Date</Label>
                        <Input
                          id="date"
                          type="date"
                          value={transactionForm.date}
                          onChange={(e) => setTransactionForm({ ...transactionForm, date: e.target.value })}
                          required
                        />
                      </div>
                      <div>
                        <Label htmlFor="description">Description</Label>
                        <Input
                          id="description"
                          value={transactionForm.description}
                          onChange={(e) => setTransactionForm({ ...transactionForm, description: e.target.value })}
                          placeholder="e.g., Grocery Store"
                          required
                        />
                      </div>
                      <div>
                        <Label htmlFor="amount">Amount</Label>
                        <Input
                          id="amount"
                          type="number"
                          step="0.01"
                          value={transactionForm.amount}
                          onChange={(e) => setTransactionForm({ ...transactionForm, amount: e.target.value })}
                          placeholder="Positive for deposits, negative for withdrawals"
                          required
                        />
                        <p className="text-xs text-muted-foreground mt-1">
                          Tip: Use positive numbers for deposits/credits, negative for withdrawals/debits
                        </p>
                      </div>
                      <div>
                        <Label htmlFor="category">Category (Optional)</Label>
                        {showAddCategory ? (
                          <div className="space-y-2">
                            <div className="flex gap-2">
                              <Input
                                placeholder="New category name"
                                value={newCategoryName}
                                onChange={(e) => setNewCategoryName(e.target.value)}
                              />
                              <Input
                                placeholder="Icon"
                                value={newCategoryIcon}
                                onChange={(e) => setNewCategoryIcon(e.target.value)}
                                className="w-20"
                              />
                            </div>
                            <div className="flex gap-2">
                              <Select value={newCategoryType} onValueChange={(value: any) => setNewCategoryType(value)}>
                                <SelectTrigger>
                                  <SelectValue />
                                </SelectTrigger>
                                <SelectContent>
                                  <SelectItem value="expense">Expense</SelectItem>
                                  <SelectItem value="income">Income</SelectItem>
                                  <SelectItem value="transfer">Transfer</SelectItem>
                                </SelectContent>
                              </Select>
                              <Input
                                type="color"
                                value={newCategoryColor}
                                onChange={(e) => setNewCategoryColor(e.target.value)}
                                className="w-20"
                              />
                            </div>
                            <div className="flex gap-2">
                              <Button type="button" size="sm" onClick={handleAddCategory}>
                                Save Category
                              </Button>
                              <Button type="button" size="sm" variant="outline" onClick={() => setShowAddCategory(false)}>
                                Cancel
                              </Button>
                            </div>
                          </div>
                        ) : (
                          <div className="space-y-2">
                            <Select
                              value={transactionForm.category}
                              onValueChange={(value) => {
                                if (value === '__add_new__') {
                                  setShowAddCategory(true);
                                } else {
                                  setTransactionForm({ ...transactionForm, category: value });
                                }
                              }}
                            >
                              <SelectTrigger>
                                <SelectValue placeholder="Select a category" />
                              </SelectTrigger>
                              <SelectContent>
                                {categories.map((cat) => (
                                  <SelectItem key={cat.id} value={cat.name}>
                                    <span className="flex items-center gap-2">
                                      {cat.icon && <span>{cat.icon}</span>}
                                      <span>{cat.name}</span>
                                    </span>
                                  </SelectItem>
                                ))}
                                <SelectItem value="__add_new__">
                                  <span className="flex items-center gap-2">
                                    <Plus className="h-4 w-4" />
                                    <span>Add New Category</span>
                                  </span>
                                </SelectItem>
                              </SelectContent>
                            </Select>
                          </div>
                        )}
                      </div>
                      <div>
                        <Label htmlFor="notes">Notes (Optional)</Label>
                        <Textarea
                          id="notes"
                          value={transactionForm.notes}
                          onChange={(e) => setTransactionForm({ ...transactionForm, notes: e.target.value })}
                          placeholder="Additional details..."
                        />
                      </div>
                      <div>
                        <Label htmlFor="debt">Link to Debt (Optional)</Label>
                        <Select
                          value={transactionForm.debt_id || 'none'}
                          onValueChange={(value) => setTransactionForm({ ...transactionForm, debt_id: value === 'none' ? '' : value })}
                        >
                          <SelectTrigger>
                            <SelectValue placeholder="Select a debt" />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="none">None</SelectItem>
                            {debts.map((debt) => (
                              <SelectItem key={debt.id} value={debt.id}>
                                <span className="flex items-center gap-2">
                                  <span>{debt.name}</span>
                                  <span className="text-xs text-muted-foreground">
                                    (${debt.current_balance.toFixed(2)})
                                  </span>
                                </span>
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                        <p className="text-xs text-muted-foreground mt-1">
                          Link this transaction to a debt for automatic payment tracking
                        </p>
                      </div>
                    </div>
                    <DialogFooter className="mt-6">
                      <Button type="button" variant="outline" onClick={() => setAddDialogOpen(false)}>
                        Cancel
                      </Button>
                      <Button type="submit" disabled={loading}>
                        {loading ? 'Adding...' : 'Add Transaction'}
                      </Button>
                    </DialogFooter>
                  </form>
                </DialogContent>
              </Dialog>
            )}
          </div>
        </div>

        <Card>
          <CardHeader>
            <CardTitle>Current Balance</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-4xl font-bold" style={{ color: account.color }}>
              ${account.balance.toFixed(2)}
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <div>
                <CardTitle>Transaction Register</CardTitle>
                <CardDescription>
                  {transactions.length} transaction{transactions.length !== 1 ? 's' : ''}
                </CardDescription>
              </div>
              {transactions.length > 0 && (
                <Button variant="outline" size="sm">
                  <Download className="h-4 w-4 mr-2" />
                  Export
                </Button>
              )}
            </div>
          </CardHeader>
          <CardContent>
            {transactions.length === 0 ? (
              <div className="text-center py-12">
                <p className="text-muted-foreground mb-4">No transactions yet</p>
                {!isPlaidAccount && (
                  <Button onClick={() => setAddDialogOpen(true)}>
                    <Plus className="h-4 w-4 mr-2" />
                    Add First Transaction
                  </Button>
                )}
              </div>
            ) : (
              <div className="border rounded-lg">
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Date</TableHead>
                      <TableHead>Description</TableHead>
                      <TableHead>Category</TableHead>
                      <TableHead className="text-right">Debit</TableHead>
                      <TableHead className="text-right">Credit</TableHead>
                      <TableHead className="text-right">Balance</TableHead>
                      <TableHead className="w-[100px]"></TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {runningBalance.map((transaction) => (
                      <TableRow key={transaction.id} className={transaction.is_pending ? 'opacity-60' : ''}>
                        <TableCell>
                          <div>
                            {format(parseISO(transaction.date), 'MMM d, yyyy')}
                            {transaction.is_pending && (
                              <Badge variant="outline" className="ml-2 text-xs">Pending</Badge>
                            )}
                          </div>
                        </TableCell>
                        <TableCell>
                          <div>
                            <div className="font-medium">{transaction.description}</div>
                            {transaction.notes && (
                              <div className="text-xs text-muted-foreground">{transaction.notes}</div>
                            )}
                          </div>
                        </TableCell>
                        <TableCell>
                          {transaction.category && (() => {
                            const category = categories.find(c => c.name === transaction.category);
                            return (
                              <Badge variant="secondary" className="text-xs flex items-center gap-1 w-fit">
                                {category?.icon && <span>{category.icon}</span>}
                                <span>{transaction.category}</span>
                              </Badge>
                            );
                          })()}
                        </TableCell>
                        <TableCell className="text-right">
                          {transaction.amount < 0 && (
                            <span className="text-red-600 font-medium">
                              ${Math.abs(transaction.amount).toFixed(2)}
                            </span>
                          )}
                        </TableCell>
                        <TableCell className="text-right">
                          {transaction.amount > 0 && (
                            <span className="text-green-600 font-medium">
                              ${transaction.amount.toFixed(2)}
                            </span>
                          )}
                        </TableCell>
                        <TableCell className="text-right font-medium">
                          ${transaction.balance.toFixed(2)}
                        </TableCell>
                        <TableCell>
                          {!transaction.plaid_transaction_id && (
                            <div className="flex items-center gap-1">
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => openEditDialog(transaction)}
                              >
                                <Edit2 className="h-4 w-4" />
                              </Button>
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => handleDeleteTransaction(transaction)}
                              >
                                <Trash2 className="h-4 w-4" />
                              </Button>
                            </div>
                          )}
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>
            )}
          </CardContent>
        </Card>

        {editingTransaction && (
          <Dialog open={!!editingTransaction} onOpenChange={() => setEditingTransaction(null)}>
            <DialogContent>
              <DialogHeader>
                <DialogTitle>Edit Transaction</DialogTitle>
                <DialogDescription>
                  Update the transaction details
                </DialogDescription>
              </DialogHeader>
              <form onSubmit={handleEditTransaction}>
                <div className="space-y-4">
                  <div>
                    <Label htmlFor="edit-date">Date</Label>
                    <Input
                      id="edit-date"
                      type="date"
                      value={transactionForm.date}
                      onChange={(e) => setTransactionForm({ ...transactionForm, date: e.target.value })}
                      required
                    />
                  </div>
                  <div>
                    <Label htmlFor="edit-description">Description</Label>
                    <Input
                      id="edit-description"
                      value={transactionForm.description}
                      onChange={(e) => setTransactionForm({ ...transactionForm, description: e.target.value })}
                      required
                    />
                  </div>
                  <div>
                    <Label htmlFor="edit-amount">Amount</Label>
                    <Input
                      id="edit-amount"
                      type="number"
                      step="0.01"
                      value={transactionForm.amount}
                      onChange={(e) => setTransactionForm({ ...transactionForm, amount: e.target.value })}
                      required
                    />
                  </div>
                  <div>
                    <Label htmlFor="edit-category">Category</Label>
                    <Select
                      value={transactionForm.category}
                      onValueChange={(value) => {
                        if (value === '__add_new__') {
                          setShowAddCategory(true);
                        } else {
                          setTransactionForm({ ...transactionForm, category: value });
                        }
                      }}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Select a category" />
                      </SelectTrigger>
                      <SelectContent>
                        {categories.map((cat) => (
                          <SelectItem key={cat.id} value={cat.name}>
                            <span className="flex items-center gap-2">
                              {cat.icon && <span>{cat.icon}</span>}
                              <span>{cat.name}</span>
                            </span>
                          </SelectItem>
                        ))}
                        <SelectItem value="__add_new__">
                          <span className="flex items-center gap-2">
                            <Plus className="h-4 w-4" />
                            <span>Add New Category</span>
                          </span>
                        </SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label htmlFor="edit-notes">Notes</Label>
                    <Textarea
                      id="edit-notes"
                      value={transactionForm.notes}
                      onChange={(e) => setTransactionForm({ ...transactionForm, notes: e.target.value })}
                    />
                  </div>
                  <div>
                    <Label htmlFor="edit-debt">Link to Debt (Optional)</Label>
                    <Select
                      value={transactionForm.debt_id || 'none'}
                      onValueChange={(value) => setTransactionForm({ ...transactionForm, debt_id: value === 'none' ? '' : value })}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Select a debt" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="none">None</SelectItem>
                        {debts.map((debt) => (
                          <SelectItem key={debt.id} value={debt.id}>
                            <span className="flex items-center gap-2">
                              <span>{debt.name}</span>
                              <span className="text-xs text-muted-foreground">
                                (${debt.current_balance.toFixed(2)})
                              </span>
                            </span>
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <p className="text-xs text-muted-foreground mt-1">
                      Link this transaction to a debt for automatic payment tracking
                    </p>
                  </div>
                </div>
                <DialogFooter className="mt-6">
                  <Button type="button" variant="outline" onClick={() => setEditingTransaction(null)}>
                    Cancel
                  </Button>
                  <Button type="submit" disabled={loading}>
                    {loading ? 'Updating...' : 'Update Transaction'}
                  </Button>
                </DialogFooter>
              </form>
            </DialogContent>
          </Dialog>
        )}
      </div>
    </DashboardLayout>
  );
}
